<!DOCTYPE html>
<html lang="zh-Hans-TW" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•°æ­¥æ“ä½œé©—è­‰ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result-box {
            min-height: 100px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center mb-4">ç•°æ­¥æ“ä½œé©—è­‰ç³»çµ±</h1>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>é•·æ™‚é–“é‹è¡Œä»»å‹™</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="taskName" class="form-label">ä»»å‹™åç¨±:</label>
                        <input type="text" class="form-control" id="taskName" value="ç¤ºä¾‹ä»»å‹™">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="performTask()">åŸ·è¡Œç•°æ­¥ä»»å‹™[url: /async/task]</button>
                    <div id="taskResult" class="result-box"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>é•·æ™‚é–“é‹è¡Œä»»å‹™-å¤šç­†</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="timeout" class="form-label">ç­‰å¾…æ™‚é–“:</label>
                        <input type="text" class="form-control" id="timeout" value="10">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="performTasks()">åŸ·è¡Œç•°æ­¥ä»»å‹™[url: /async/tasks]</button>
                    <div id="tasksResult" class="result-box"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>åŒæ­¥å‘¼å«éåŒæ­¥-é•·æ™‚é–“é‹è¡Œä»»å‹™</h5>
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-primary" onclick="syncToAsyncPerformTask()">åŸ·è¡Œç•°æ­¥ä»»å‹™[url: /sync/to-async-perform-task]</button>
                    <div id="syncToAsyncPerformTaskResult" class="result-box"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>åŒæ­¥å‘¼å«å¤šç­†éåŒæ­¥-é•·æ™‚é–“é‹è¡Œä»»å‹™</h5>
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-primary" onclick="syncToMultipleAsyncPerformTask()">åŸ·è¡Œç•°æ­¥ä»»å‹™[url: /sync/to-multiple-async-perform-task]</button>
                    <div id="syncToMultipleAsyncPerformTaskResult" class="result-box"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>éšä¹˜è¨ˆç®—</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="number" class="form-label">æ•¸å­—:</label>
                        <input type="number" class="form-control" id="number" value="5" min="1" max="10">
                    </div>
                    <button type="button" class="btn btn-success" onclick="calculateFactorial()">è¨ˆç®—éšä¹˜</button>
                    <div id="factorialResult" class="result-box"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>ç™¼é€éƒµä»¶</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="recipient" class="form-label">æ”¶ä»¶äºº:</label>
                        <input type="email" class="form-control" id="recipient" value="test@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">ä¸»é¡Œ:</label>
                        <input type="text" class="form-control" id="subject" value="æ¸¬è©¦éƒµä»¶">
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">å…§å®¹:</label>
                        <textarea class="form-control" id="content" rows="3">é€™æ˜¯ä¸€å°æ¸¬è©¦éƒµä»¶</textarea>
                    </div>
                    <button type="button" class="btn btn-info" onclick="sendEmail()">ç™¼é€éƒµä»¶</button>
                    <div id="emailResult" class="result-box"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>å¤šé‡ä»»å‹™åŸ·è¡Œ</h5>
                </div>
                <div class="card-body">
                    <p>åŒæ™‚åŸ·è¡Œå¤šå€‹ç•°æ­¥ä»»å‹™</p>
                    <button type="button" class="btn btn-warning" onclick="performMultipleTasks()">åŸ·è¡Œå¤šé‡ä»»å‹™[url: /async/multiple]</button>
                    <div id="multipleResult" class="result-box"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>å³æ™‚ä¸²æµå¤šä»»å‹™åŸ·è¡Œ (SSE)</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="streamTasksTimeout" class="form-label">ç­‰å¾…æ™‚é–“:</label>
                        <input type="text" class="form-control" id="streamTasksTimeout" value="10">
                        <label for="streamTasks" class="form-label">ä»»å‹™åˆ—è¡¨ (é€—è™Ÿåˆ†éš”):</label>
                        <input type="text" class="form-control" id="streamTasks" value="ä»»å‹™A,ä»»å‹™B,ä»»å‹™C,ä»»å‹™D">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="startTaskStream()">é–‹å§‹å³æ™‚ä»»å‹™ä¸²æµ</button>
                    <button type="button" class="btn btn-danger" onclick="stopTaskStream()">åœæ­¢ä¸²æµ</button>
                    <div id="taskStreamResult" class="result-box"></div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Server-Sent Events (SSE) æ¼”ç¤º</h5>
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-secondary" onclick="startSSE()">é–‹å§‹ SSE ä¸²æµ</button>
                    <button type="button" class="btn btn-danger" onclick="stopSSE()">åœæ­¢ SSE ä¸²æµ</button>
                    <div id="sseResult" class="result-box"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let eventSource = null;
    let taskStreamSource = null;

    function showLoading(elementId) {
        document.getElementById(elementId).innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">è¼‰å…¥ä¸­...</span></div> è™•ç†ä¸­...';
    }

    function performTask() {
        const taskName = document.getElementById('taskName').value;
        showLoading('taskResult');

        fetch('/av/async/task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'taskName=' + encodeURIComponent(taskName)
        })
        .then(response => response.text())
        .then(data => {
            document.getElementById('taskResult').innerHTML = '<strong>çµæœ:</strong> ' + data;
        })
        .catch(error => {
            document.getElementById('taskResult').innerHTML = '<strong>éŒ¯èª¤:</strong> ' + error;
        });
    }

    function performTasks() {
        const timeout = document.getElementById('timeout').value;
        showLoading('tasksResult');

        fetch('/av/async/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'timeout=' + encodeURIComponent(timeout)
        })
        .then(response => response.text())
        .then(data => {
            document.getElementById('tasksResult').innerHTML = '<strong>çµæœ:</strong> ' + data;
        })
        .catch(error => {
            document.getElementById('tasksResult').innerHTML = '<strong>éŒ¯èª¤:</strong> ' + error;
        });
    }

    function syncToAsyncPerformTask() {
<!--        const taskName = document.getElementById('taskName').value;-->
        showLoading('syncToAsyncPerformTaskResult');

        fetch('/av/sync/to-async-perform-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
<!--            body: 'taskName=' + encodeURIComponent(taskName)-->
        })
        .then(response => response.text())
        .then(data => {
            document.getElementById('syncToAsyncPerformTaskResult').innerHTML = '<strong>çµæœ:</strong> ' + data;
        })
        .catch(error => {
            document.getElementById('syncToAsyncPerformTaskResult').innerHTML = '<strong>éŒ¯èª¤:</strong> ' + error;
        });
    }

    function syncToMultipleAsyncPerformTask() {
        showLoading('syncToMultipleAsyncPerformTaskResult');

        fetch('/av/sync/to-multiple-async-perform-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
        })
        .then(response => response.text())
        .then(data => {
            document.getElementById('syncToMultipleAsyncPerformTaskResult').innerHTML = '<strong>çµæœ:</strong> ' + data;
        })
        .catch(error => {
            document.getElementById('syncToMultipleAsyncPerformTaskResult').innerHTML = '<strong>éŒ¯èª¤:</strong> ' + error;
        });
    }

    function calculateFactorial() {
        const number = document.getElementById('number').value;
        showLoading('factorialResult');

        fetch('/av/async/factorial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'number=' + encodeURIComponent(number)
        })
        .then(response => response.text())
        .then(data => {
            document.getElementById('factorialResult').innerHTML = '<strong>çµæœ:</strong> ' + data;
        })
        .catch(error => {
            document.getElementById('factorialResult').innerHTML = '<strong>éŒ¯èª¤:</strong> ' + error;
        });
    }

    function sendEmail() {
        const recipient = document.getElementById('recipient').value;
        const subject = document.getElementById('subject').value;
        const content = document.getElementById('content').value;
        showLoading('emailResult');

        fetch('/av/async/email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'recipient=' + encodeURIComponent(recipient) +
                  '&subject=' + encodeURIComponent(subject) +
                  '&content=' + encodeURIComponent(content)
        })
        .then(response => response.text())
        .then(data => {
            document.getElementById('emailResult').innerHTML = '<strong>çµæœ:</strong> ' + data;
        })
        .catch(error => {
            document.getElementById('emailResult').innerHTML = '<strong>éŒ¯èª¤:</strong> ' + error;
        });
    }

    function performMultipleTasks() {
        showLoading('multipleResult');

        fetch('/av/async/multiple')
        .then(response => response.text())
        .then(data => {
            document.getElementById('multipleResult').innerHTML = '<strong>çµæœ:</strong> ' + data;
        })
        .catch(error => {
            document.getElementById('multipleResult').innerHTML = '<strong>éŒ¯èª¤:</strong> ' + error;
        });
    }

    function startSSE() {
        if (eventSource) {
            eventSource.close();
        }

        document.getElementById('sseResult').innerHTML = 'é€£æ¥ SSE ä¸²æµ...<br>';

        eventSource = new EventSource('/sse');

        eventSource.onmessage = function(event) {
            const sseResult = document.getElementById('sseResult');
            sseResult.innerHTML += event.data + '<br>';
            sseResult.scrollTop = sseResult.scrollHeight;
        };

        eventSource.onerror = function(event) {
            document.getElementById('sseResult').innerHTML += 'SSE é€£æ¥éŒ¯èª¤<br>';
        };

        eventSource.onopen = function(event) {
            document.getElementById('sseResult').innerHTML += 'SSE é€£æ¥å·²å»ºç«‹<br>';
        };
    }

    function stopSSE() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
            document.getElementById('sseResult').innerHTML += 'SSE é€£æ¥å·²é—œé–‰<br>';
        }
    }

    function startTaskStream() {
        if (taskStreamSource) {
            taskStreamSource.close();
        }
        const timeout = document.getElementById('streamTasksTimeout').value;

        const tasks = document.getElementById('streamTasks').value;
        const resultDiv = document.getElementById('taskStreamResult');
        resultDiv.innerHTML = '<div class="alert alert-info">ğŸ”„ é€£æ¥ä»»å‹™ä¸²æµä¸­...<br>ç­‰å¾…ä»»å‹™å®Œæˆ...</div>';

        let completedCount = 0;
        const startTime = new Date();

        taskStreamSource = new EventSource('/av/async/tasks/stream?tasks=' + encodeURIComponent(tasks) + '&timeout=' + encodeURIComponent(timeout));

        taskStreamSource.addEventListener('task-completed', function(event) {
            completedCount++;
            const elapsed = ((new Date() - startTime) / 1000).toFixed(2);
            resultDiv.innerHTML += `<div class="alert alert-success mb-1">âœ… [${elapsed}ç§’] ä»»å‹™ ${completedCount} å®Œæˆ: ${event.data}</div>`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        });

        taskStreamSource.addEventListener('all-completed', function(event) {
            const totalTime = ((new Date() - startTime) / 1000).toFixed(2);
            resultDiv.innerHTML += `<div class="alert alert-primary mt-2"><strong>ğŸ‰ ${event.data}</strong><br>ç¸½è€—æ™‚: ${totalTime} ç§’</div>`;
            taskStreamSource.close();
            taskStreamSource = null;
        });

        taskStreamSource.onerror = function(event) {
            resultDiv.innerHTML += '<div class="alert alert-danger">âŒ SSE é€£æ¥éŒ¯èª¤</div>';
            if (taskStreamSource) {
                taskStreamSource.close();
                taskStreamSource = null;
            }
        };
    }

    function stopTaskStream() {
        if (taskStreamSource) {
            taskStreamSource.close();
            taskStreamSource = null;
            document.getElementById('taskStreamResult').innerHTML += '<div class="alert alert-warning">âš ï¸ ä»»å‹™ä¸²æµå·²æ‰‹å‹•é—œé–‰</div>';
        }
    }
</script>
</body>
</html>